<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1a">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<title>LineaPelle 2026</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1a1a;--bg2:#242424;--bg3:#2e2e2e;
  --fg:#f0f0f0;--fg2:#aaa;--fg3:#777;
  --cyan:#00BCD4;--purple:#9C27B0;--yellow:#FFC107;
  --accent:#8B5A2B;--danger:#e53935;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{
  height:100%;background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;overflow:hidden;
  touch-action:pan-y;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header{
  position:fixed;top:0;left:0;right:0;z-index:100;
  background:var(--bg);
  padding-top:calc(var(--safe-top) + 8px);
  border-bottom:1px solid var(--bg3);
}
.header-title{
  text-align:center;font-size:20px;font-weight:700;
  padding:0 16px 8px;letter-spacing:0.5px;color:var(--fg);
}
.header-actions{
  position:absolute;right:12px;top:calc(var(--safe-top) + 6px);
  display:flex;gap:8px;
}
.header-actions button{
  background:none;border:none;color:var(--fg2);font-size:20px;
  padding:6px;cursor:pointer;border-radius:8px;
}
.header-actions button:active{background:var(--bg3)}
.tabs{display:flex;border-bottom:1px solid var(--bg3)}
.tab{
  flex:1;text-align:center;padding:10px 0;font-size:14px;font-weight:600;
  color:var(--fg3);cursor:pointer;position:relative;
  transition:color .2s;
}
.tab.active{color:var(--fg)}
.tab.active::after{
  content:'';position:absolute;bottom:-1px;left:20%;right:20%;
  height:2px;background:var(--accent);border-radius:2px;
}
.tab-count{font-weight:400;color:var(--fg3);font-size:12px;margin-left:4px}

/* ‚îÄ‚îÄ List ‚îÄ‚îÄ */
.list-container{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  padding-top:calc(var(--safe-top) + 90px);
  padding-bottom:calc(var(--safe-bot) + 16px);
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.list{padding:8px 12px}
.empty-state{
  text-align:center;color:var(--fg3);padding:60px 20px;font-size:15px;
}

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card{
  background:var(--bg2);border-radius:12px;padding:14px 16px;
  margin-bottom:8px;position:relative;overflow:hidden;
  transition:transform .3s ease,opacity .3s ease;
  cursor:pointer;user-select:none;-webkit-user-select:none;
}
.card.swiping{transition:none}
.card.removing{pointer-events:none}
.card-inner{display:flex;align-items:flex-start;gap:10px}
.card-colors{
  display:flex;flex-direction:column;gap:3px;
  padding-top:3px;flex-shrink:0;
}
.card-dot{width:6px;height:6px;border-radius:50%}
.card-body{flex:1;min-width:0}
.card-name{font-size:15px;font-weight:600;line-height:1.3}
.card-booth{font-size:13px;color:var(--fg2);margin-top:2px}
.card-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.tag-pill{
  font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px;
  text-transform:uppercase;letter-spacing:0.3px;
}
.tag-pill.transparent{background:rgba(0,188,212,.15);color:var(--cyan)}
.tag-pill.exotic{background:rgba(156,39,176,.15);color:var(--purple)}
.tag-pill.novel{background:rgba(255,193,7,.15);color:var(--yellow)}
.swipe-hint{
  position:absolute;top:0;bottom:0;width:80px;
  display:flex;align-items:center;justify-content:center;
  font-size:24px;font-weight:700;opacity:0;
  transition:opacity .15s;pointer-events:none;
}
.swipe-hint.right{right:0;left:auto;background:linear-gradient(to left,rgba(76,175,80,.3),transparent)}
.swipe-hint.left{left:0;right:auto;background:linear-gradient(to right,rgba(244,67,54,.3),transparent)}

/* ‚îÄ‚îÄ Detail View ‚îÄ‚îÄ */
.detail-view{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;
  background:var(--bg);
  transform:translateX(100%);transition:transform .3s ease;
  overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding-top:calc(var(--safe-top));
  padding-bottom:calc(var(--safe-bot) + 20px);
}
.detail-view.open{transform:translateX(0)}
.detail-header{
  position:sticky;top:0;z-index:10;background:var(--bg);
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;border-bottom:1px solid var(--bg3);
}
.detail-back{
  background:none;border:none;color:var(--fg);font-size:15px;
  cursor:pointer;padding:6px 10px;border-radius:8px;
  display:flex;align-items:center;gap:4px;
}
.detail-back:active{background:var(--bg3)}
.detail-back:disabled{opacity:.3;pointer-events:none}
.detail-back .arrow{font-size:18px}
.rec-btn{
  background:var(--danger);color:#fff;border:none;
  font-size:14px;font-weight:600;padding:8px 14px;border-radius:20px;
  cursor:pointer;display:flex;align-items:center;gap:6px;
  transition:background .2s;
}
.rec-btn:active{filter:brightness(.85)}
.rec-btn.recording{animation:pulse 1.2s infinite}
.rec-timer{font-variant-numeric:tabular-nums;font-size:13px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

.detail-content{padding:16px}
.detail-name{font-size:22px;font-weight:700;margin-bottom:4px}
.detail-booth{font-size:14px;color:var(--fg2);margin-bottom:12px}
.detail-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:16px}

.section{margin-bottom:20px}
.section-title{
  font-size:12px;font-weight:700;text-transform:uppercase;
  letter-spacing:1px;color:var(--fg3);margin-bottom:8px;
  padding-bottom:4px;border-bottom:1px solid var(--bg3);
}
.field{margin-bottom:8px}
.field-label{font-size:12px;color:var(--fg3);margin-bottom:1px}
.field-value{font-size:14px;line-height:1.4}
.field-value a{color:var(--cyan);text-decoration:none}
.field-value a:active{text-decoration:underline}

/* ‚îÄ‚îÄ Recordings ‚îÄ‚îÄ */
.recording-item{
  background:var(--bg3);border-radius:10px;padding:12px;
  margin-bottom:6px;display:flex;align-items:center;gap:10px;
}
.recording-info{flex:1;min-width:0}
.recording-time{font-size:12px;color:var(--fg2)}
.recording-dur{font-size:11px;color:var(--fg3)}
.recording-actions{display:flex;gap:6px}
.recording-actions button{
  background:var(--bg2);border:none;color:var(--fg);
  width:36px;height:36px;border-radius:50%;font-size:16px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.recording-actions button:active{background:var(--bg)}

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
.search-bar{
  padding:8px 12px;position:sticky;top:0;z-index:10;
}
.search-input{
  width:100%;padding:10px 14px 10px 36px;border-radius:10px;
  border:none;background:var(--bg3);color:var(--fg);font-size:15px;
  outline:none;
}
.search-input::placeholder{color:var(--fg3)}
.search-icon{
  position:absolute;left:24px;top:50%;transform:translateY(-50%);
  color:var(--fg3);font-size:14px;pointer-events:none;
}

/* ‚îÄ‚îÄ Audio Player ‚îÄ‚îÄ */
.audio-playing{background:var(--accent) !important}
</style>
</head>
<body>

<!-- List View -->
<div class="header" id="listHeader">
  <div class="header-title">LineaPelle 2026</div>
  <div class="header-actions">
    <button onclick="exportAllRecordings()" title="Export recordings" id="exportBtn">üì¶</button>
  </div>
  <div class="tabs">
    <div class="tab active" id="tabUpcoming" onclick="switchTab('upcoming')">
      Upcoming <span class="tab-count" id="countUpcoming"></span>
    </div>
    <div class="tab" id="tabVisited" onclick="switchTab('visited')">
      Visited <span class="tab-count" id="countVisited"></span>
    </div>
  </div>
</div>

<div class="list-container" id="listContainer">
  <div class="search-bar">
    <span class="search-icon">üîç</span>
    <input class="search-input" id="searchInput" type="text" placeholder="Search tanneries..." oninput="renderList()">
  </div>
  <div class="list" id="list"></div>
</div>

<!-- Detail View -->
<div class="detail-view" id="detailView">
  <div class="detail-header">
    <button class="detail-back" id="backBtn" onclick="closeDetail()">
      <span class="arrow">‚Äπ</span> Back
    </button>
    <button class="rec-btn" id="recBtn" onclick="toggleRecording()">
      <span id="recIcon">üéô</span>
      <span id="recLabel">Record</span>
      <span class="rec-timer" id="recTimer" style="display:none">00:00</span>
    </button>
  </div>
  <div class="detail-content" id="detailContent"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let tanneries = [];
let visited = {};        // { id: timestamp }
let activeTab = 'upcoming';
let currentTannery = null;
let db = null;

// Recording state
let mediaRecorder = null;
let recordingChunks = [];
let recordingStart = 0;
let recordingTimer = null;
let isRecording = false;

// Audio playback
let currentAudio = null;
let currentPlayBtn = null;

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
async function init() {
  // Load data
  const resp = await fetch('tanneries.json');
  tanneries = await resp.json();

  // Sort by booth
  tanneries.sort((a, b) => {
    const ba = a['Booth'] || '', bb = b['Booth'] || '';
    return ba.localeCompare(bb, undefined, { numeric: true });
  });

  // Load visited state
  try {
    const saved = localStorage.getItem('lp_visited');
    if (saved) visited = JSON.parse(saved);
  } catch(e) {}

  // Open IndexedDB
  db = await openDB();

  renderList();
}

function saveVisited() {
  localStorage.setItem('lp_visited', JSON.stringify(visited));
}

// ‚îÄ‚îÄ‚îÄ IndexedDB ‚îÄ‚îÄ‚îÄ
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('LineaPelleRecordings', 1);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('recordings')) {
        const store = db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
        store.createIndex('tanneryId', 'tanneryId', { unique: false });
      }
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

function dbAdd(record) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readwrite');
    const req = tx.objectStore('recordings').add(record);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbGetByTannery(tanneryId) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readonly');
    const idx = tx.objectStore('recordings').index('tanneryId');
    const req = idx.getAll(tanneryId);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbGetAll() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readonly');
    const req = tx.objectStore('recordings').getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbDelete(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readwrite');
    const req = tx.objectStore('recordings').delete(id);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

// ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  activeTab = tab;
  document.getElementById('tabUpcoming').classList.toggle('active', tab === 'upcoming');
  document.getElementById('tabVisited').classList.toggle('active', tab === 'visited');
  document.getElementById('searchInput').value = '';
  renderList();
}

// ‚îÄ‚îÄ‚îÄ Tag helpers ‚îÄ‚îÄ‚îÄ
function getSpecialTags(tags) {
  if (!tags) return [];
  const result = [];
  if (tags.includes('TRANSPARENT_LEATHER')) result.push({ key: 'transparent', label: 'Transparent', color: 'var(--cyan)' });
  if (tags.includes('EXOTIC_HIDE')) result.push({ key: 'exotic', label: 'Exotic', color: 'var(--purple)' });
  if (tags.includes('NOVEL_MATERIAL')) result.push({ key: 'novel', label: 'Novel', color: 'var(--yellow)' });
  return result;
}

// ‚îÄ‚îÄ‚îÄ Render List ‚îÄ‚îÄ‚îÄ
function renderList() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const listEl = document.getElementById('list');
  const isVisited = activeTab === 'visited';

  let items = tanneries.filter(t => {
    const isV = visited[t.id] !== undefined;
    if (isVisited !== isV) return false;
    if (search) {
      const name = (t['Company Name'] || '').toLowerCase();
      const booth = (t['Booth'] || '').toLowerCase();
      const tags = (t['Tags'] || '').toLowerCase();
      return name.includes(search) || booth.includes(search) || tags.includes(search);
    }
    return true;
  });

  if (isVisited) {
    items.sort((a, b) => (visited[b.id] || 0) - (visited[a.id] || 0));
  }

  // Update counts
  const visitedCount = tanneries.filter(t => visited[t.id] !== undefined).length;
  document.getElementById('countUpcoming').textContent = `(${tanneries.length - visitedCount})`;
  document.getElementById('countVisited').textContent = `(${visitedCount})`;

  if (items.length === 0) {
    listEl.innerHTML = `<div class="empty-state">${isVisited
      ? 'No tanneries visited yet.<br>Swipe right on a card to mark as visited.'
      : search ? 'No matches found.' : 'All tanneries visited! üéâ'
    }</div>`;
    return;
  }

  listEl.innerHTML = '';
  items.forEach(t => {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = t.id;

    const specialTags = getSpecialTags(t['Tags']);
    const dots = specialTags.map(s => `<div class="card-dot" style="background:${s.color}"></div>`).join('');
    const pills = specialTags.map(s => `<span class="tag-pill ${s.key}">${s.label}</span>`).join('');

    card.innerHTML = `
      <div class="swipe-hint right">‚úì</div>
      <div class="swipe-hint left">‚Ü©</div>
      <div class="card-inner">
        ${dots ? `<div class="card-colors">${dots}</div>` : ''}
        <div class="card-body">
          <div class="card-name">${esc(t['Company Name'])}</div>
          <div class="card-booth">${esc(t['Booth'])}</div>
          ${pills ? `<div class="card-tags">${pills}</div>` : ''}
        </div>
      </div>
    `;

    setupSwipe(card, t.id, isVisited);
    card.addEventListener('click', e => {
      if (card.classList.contains('swiping')) return;
      openDetail(t);
    });

    listEl.appendChild(card);
  });
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ‚îÄ‚îÄ‚îÄ Swipe ‚îÄ‚îÄ‚îÄ
function setupSwipe(card, tanneryId, isVisitedTab) {
  let startX = 0, startY = 0, dx = 0, swiping = false, locked = false;
  const threshold = 80;

  card.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    dx = 0; swiping = false; locked = false;
    card.classList.remove('swiping');
  }, { passive: true });

  card.addEventListener('touchmove', e => {
    if (locked) return;
    const cx = e.touches[0].clientX;
    const cy = e.touches[0].clientY;
    const deltaX = cx - startX;
    const deltaY = cy - startY;

    // Lock direction after initial movement
    if (!swiping && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) return;
    if (!swiping) {
      if (Math.abs(deltaY) > Math.abs(deltaX)) { locked = true; return; }
      swiping = true;
      card.classList.add('swiping');
    }

    // On Upcoming tab: only allow right swipe. On Visited tab: only allow left swipe.
    if (!isVisitedTab && deltaX < 0) { dx = 0; card.style.transform = ''; return; }
    if (isVisitedTab && deltaX > 0) { dx = 0; card.style.transform = ''; return; }

    dx = deltaX;
    card.style.transform = `translateX(${dx}px)`;

    const hintR = card.querySelector('.swipe-hint.right');
    const hintL = card.querySelector('.swipe-hint.left');
    if (hintR) hintR.style.opacity = (!isVisitedTab && dx > 30) ? '1' : '0';
    if (hintL) hintL.style.opacity = (isVisitedTab && dx < -30) ? '1' : '0';
  }, { passive: true });

  card.addEventListener('touchend', e => {
    if (!swiping) return;
    card.classList.remove('swiping');

    const didSwipe = (!isVisitedTab && dx > threshold) || (isVisitedTab && dx < -threshold);
    if (didSwipe) {
      const dir = isVisitedTab ? -1 : 1;
      card.classList.add('removing');
      card.style.transition = 'transform .3s ease, opacity .3s ease';
      card.style.transform = `translateX(${dir * window.innerWidth}px)`;
      card.style.opacity = '0';

      setTimeout(() => {
        if (isVisitedTab) {
          delete visited[tanneryId];
        } else {
          visited[tanneryId] = Date.now();
        }
        saveVisited();
        renderList();
      }, 300);
    } else {
      card.style.transition = 'transform .2s ease';
      card.style.transform = '';
      const hints = card.querySelectorAll('.swipe-hint');
      hints.forEach(h => h.style.opacity = '0');
      setTimeout(() => { card.style.transition = ''; }, 200);
    }
  }, { passive: true });
}

// ‚îÄ‚îÄ‚îÄ Detail View ‚îÄ‚îÄ‚îÄ
async function openDetail(tannery) {
  currentTannery = tannery;
  const view = document.getElementById('detailView');
  const content = document.getElementById('detailContent');

  const specialTags = getSpecialTags(tannery['Tags']);
  const pills = specialTags.map(s => `<span class="tag-pill ${s.key}">${s.label}</span>`).join('');

  let html = `
    <div class="detail-name">${esc(tannery['Company Name'])}</div>
    <div class="detail-booth">${esc(tannery['Booth'])}</div>
    ${pills ? `<div class="detail-tags">${pills}</div>` : ''}
  `;

  // Basic Info
  const basicFields = [];
  addField(basicFields, 'Country', tannery['Country']);
  if (tannery['Website']) {
    const url = tannery['Website'].startsWith('http') ? tannery['Website'] : 'https://' + tannery['Website'];
    basicFields.push({ label: 'Website', value: `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(tannery['Website'])}</a>` });
  }
  if (tannery['Email']) {
    basicFields.push({ label: 'Email', value: `<a href="mailto:${esc(tannery['Email'])}">${esc(tannery['Email'])}</a>` });
  }
  if (tannery['Phone']) {
    basicFields.push({ label: 'Phone', value: `<a href="tel:${esc(tannery['Phone'])}">${esc(tannery['Phone'])}</a>` });
  }
  if (basicFields.length) html += renderSection('Basic Info', basicFields);

  // Classification
  const classFields = [];
  addField(classFields, 'Sector', tannery['Sector']);
  addField(classFields, 'Typology', tannery['Typology']);
  addField(classFields, 'Priority Score', tannery['Priority Score']);
  if (tannery['Tags']) {
    classFields.push({ label: 'Tags', value: tannery['Tags'].split(',').map(t => {
      const tag = t.trim();
      const special = getSpecialTags(tag);
      const cls = special.length ? special[0].key : '';
      return `<span class="tag-pill ${cls}" style="${cls ? '' : 'background:var(--bg3);color:var(--fg2)'}">${tag.replace(/_/g, ' ')}</span>`;
    }).join(' ') });
  }
  if (classFields.length) html += renderSection('Classification', classFields);

  // Products & Materials
  const prodFields = [];
  addField(prodFields, 'Hide Types', tannery['Hide Types']);
  addField(prodFields, 'Tanning Methods', tannery['Tanning Methods']);
  addField(prodFields, 'Thickness Range', tannery['Thickness Range']);
  addField(prodFields, 'Finishes (Catalog)', tannery['Finishes (Catalog)']);
  addField(prodFields, 'Interesting Finishes', tannery['Interesting Finishes']);
  addField(prodFields, 'Exotic Hides', tannery['Exotic Hides']);
  addField(prodFields, 'Novel Materials', tannery['Novel Materials']);
  addField(prodFields, 'Transparent Leather', tannery['Transparent Leather']);
  addField(prodFields, 'Combined Materials', tannery['Combined Materials']);
  if (prodFields.length) html += renderSection('Products & Materials', prodFields);

  // Business
  const bizFields = [];
  addField(bizFields, 'MOQ Info', tannery['MOQ Info']);
  addField(bizFields, 'Custom Work', tannery['Custom Work']);
  addField(bizFields, 'Ethical / Sustainability', tannery['Ethical/Sustainability']);
  addField(bizFields, 'Destinations', tannery['Destinations']);
  if (bizFields.length) html += renderSection('Business', bizFields);

  // Summary
  const sumFields = [];
  addField(sumFields, 'Distinctive Summary', tannery['Distinctive Summary']);
  addField(sumFields, 'Notes', tannery['Notes']);
  if (sumFields.length) html += renderSection('Summary', sumFields);

  // Voice Memos section placeholder
  html += `<div class="section"><div class="section-title">Voice Memos</div><div id="memosList"></div></div>`;

  content.innerHTML = html;
  view.classList.add('open');
  view.scrollTop = 0;

  // Load recordings
  await loadRecordings();
}

function addField(arr, label, value) {
  if (value && value.trim()) arr.push({ label, value: esc(value) });
}

function renderSection(title, fields) {
  return `<div class="section">
    <div class="section-title">${title}</div>
    ${fields.map(f => `<div class="field"><div class="field-label">${f.label}</div><div class="field-value">${f.value}</div></div>`).join('')}
  </div>`;
}

function closeDetail() {
  if (isRecording) return;
  document.getElementById('detailView').classList.remove('open');
  stopAudio();
  currentTannery = null;
}

// ‚îÄ‚îÄ‚îÄ Recordings ‚îÄ‚îÄ‚îÄ
async function loadRecordings() {
  if (!currentTannery || !db) return;
  const recs = await dbGetByTannery(currentTannery.id);
  recs.sort((a, b) => b.timestamp - a.timestamp);
  const el = document.getElementById('memosList');
  if (!recs.length) {
    el.innerHTML = '<div style="color:var(--fg3);font-size:13px">No recordings yet. Tap Record to start.</div>';
    return;
  }
  el.innerHTML = recs.map(r => `
    <div class="recording-item" id="rec-${r.id}">
      <div class="recording-info">
        <div class="recording-time">${new Date(r.timestamp).toLocaleString()}</div>
        <div class="recording-dur">${formatDuration(r.duration)}</div>
      </div>
      <div class="recording-actions">
        <button onclick="playRecording(${r.id}, this)" title="Play">‚ñ∂</button>
        <button onclick="downloadRecording(${r.id})" title="Download">üíæ</button>
        <button onclick="deleteRecording(${r.id})" title="Delete" style="color:var(--danger)">‚úï</button>
      </div>
    </div>
  `).join('');
}

function formatDuration(ms) {
  if (!ms) return '0:00';
  const s = Math.round(ms / 1000);
  const m = Math.floor(s / 60);
  return `${m}:${String(s % 60).padStart(2, '0')}`;
}

async function playRecording(id, btn) {
  stopAudio();
  const tx = db.transaction('recordings', 'readonly');
  const req = tx.objectStore('recordings').get(id);
  req.onsuccess = () => {
    const rec = req.result;
    if (!rec) return;
    const url = URL.createObjectURL(rec.blob);
    currentAudio = new Audio(url);
    currentPlayBtn = btn;
    btn.textContent = '‚è∏';
    btn.parentElement.parentElement.classList.add('audio-playing');
    currentAudio.onended = () => stopAudio();
    currentAudio.play();
  };
}

function stopAudio() {
  if (currentAudio) {
    currentAudio.pause();
    currentAudio = null;
  }
  if (currentPlayBtn) {
    currentPlayBtn.textContent = '‚ñ∂';
    currentPlayBtn.parentElement.parentElement.classList.remove('audio-playing');
    currentPlayBtn = null;
  }
}

async function downloadRecording(id) {
  const tx = db.transaction('recordings', 'readonly');
  const req = tx.objectStore('recordings').get(id);
  req.onsuccess = () => {
    const rec = req.result;
    if (!rec) return;
    const url = URL.createObjectURL(rec.blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = rec.filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  };
}

async function deleteRecording(id) {
  if (!confirm('Delete this recording?')) return;
  stopAudio();
  await dbDelete(id);
  await loadRecordings();
}

// ‚îÄ‚îÄ‚îÄ Voice Recording ‚îÄ‚îÄ‚îÄ
async function toggleRecording() {
  if (isRecording) {
    stopRecordingSession();
  } else {
    await startRecordingSession();
  }
}

async function startRecordingSession() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordingChunks = [];

    // Use webm if available, fallback to whatever the browser supports
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm')
        ? 'audio/webm'
        : 'audio/mp4';

    mediaRecorder = new MediaRecorder(stream, { mimeType });

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) recordingChunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(recordingChunks, { type: mediaRecorder.mimeType });
      const duration = Date.now() - recordingStart;
      const ext = mediaRecorder.mimeType.includes('mp4') ? 'mp4' : 'webm';
      const slug = slugify(currentTannery['Company Name']);
      const ts = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
      const filename = `${slug}_${ts}.${ext}`;

      await dbAdd({
        tanneryId: currentTannery.id,
        filename,
        timestamp: Date.now(),
        duration,
        blob
      });

      await loadRecordings();
    };

    mediaRecorder.start(1000);
    recordingStart = Date.now();
    isRecording = true;
    updateRecordingUI();

    // Timer
    recordingTimer = setInterval(() => {
      const elapsed = Date.now() - recordingStart;
      document.getElementById('recTimer').textContent = formatDuration(elapsed);
    }, 200);

  } catch (err) {
    alert('Microphone access denied. Please allow microphone access in your device settings.');
  }
}

function stopRecordingSession() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  isRecording = false;
  clearInterval(recordingTimer);
  updateRecordingUI();
}

function updateRecordingUI() {
  const btn = document.getElementById('recBtn');
  const icon = document.getElementById('recIcon');
  const label = document.getElementById('recLabel');
  const timer = document.getElementById('recTimer');
  const back = document.getElementById('backBtn');

  if (isRecording) {
    btn.classList.add('recording');
    icon.textContent = '‚èπ';
    label.textContent = 'Stop';
    timer.style.display = '';
    back.disabled = true;
  } else {
    btn.classList.remove('recording');
    icon.textContent = 'üéô';
    label.textContent = 'Record';
    timer.style.display = 'none';
    timer.textContent = '00:00';
    back.disabled = false;
  }
}

function slugify(name) {
  return (name || 'unknown').toLowerCase()
    .replace(/[^a-z0-9\s]/g, '')
    .replace(/\s+/g, '_')
    .slice(0, 50);
}

// ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ
async function exportAllRecordings() {
  const recs = await dbGetAll();
  if (!recs.length) {
    alert('No recordings to export.');
    return;
  }

  // Build a ZIP manually using a minimal approach
  // Since we can't use JSZip offline without bundling, let's download individual files
  // Actually, let's build a simple ZIP
  const files = [];
  for (const r of recs) {
    const tannery = tanneries.find(t => t.id === r.tanneryId);
    const folder = tannery ? slugify(tannery['Company Name']) : 'unknown';
    const arrayBuf = await r.blob.arrayBuffer();
    files.push({ name: `${folder}/${r.filename}`, data: new Uint8Array(arrayBuf) });
  }

  const zipBlob = createZip(files);
  const url = URL.createObjectURL(zipBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `lineapelle_recordings_${new Date().toISOString().slice(0,10)}.zip`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// ‚îÄ‚îÄ‚îÄ Minimal ZIP builder ‚îÄ‚îÄ‚îÄ
function createZip(files) {
  const localHeaders = [];
  const centralHeaders = [];
  let offset = 0;

  for (const file of files) {
    const nameBytes = new TextEncoder().encode(file.name);
    const data = file.data;
    const crc = crc32(data);

    // Local file header
    const local = new Uint8Array(30 + nameBytes.length + data.length);
    const lv = new DataView(local.buffer);
    lv.setUint32(0, 0x04034b50, true);   // signature
    lv.setUint16(4, 20, true);            // version needed
    lv.setUint16(6, 0, true);             // flags
    lv.setUint16(8, 0, true);             // compression (store)
    lv.setUint16(10, 0, true);            // mod time
    lv.setUint16(12, 0, true);            // mod date
    lv.setUint32(14, crc, true);          // crc32
    lv.setUint32(18, data.length, true);  // compressed size
    lv.setUint32(22, data.length, true);  // uncompressed size
    lv.setUint16(26, nameBytes.length, true);
    lv.setUint16(28, 0, true);            // extra field length
    local.set(nameBytes, 30);
    local.set(data, 30 + nameBytes.length);
    localHeaders.push(local);

    // Central directory header
    const central = new Uint8Array(46 + nameBytes.length);
    const cv = new DataView(central.buffer);
    cv.setUint32(0, 0x02014b50, true);
    cv.setUint16(4, 20, true);
    cv.setUint16(6, 20, true);
    cv.setUint16(8, 0, true);
    cv.setUint16(10, 0, true);
    cv.setUint16(12, 0, true);
    cv.setUint16(14, 0, true);
    cv.setUint32(16, crc, true);
    cv.setUint32(20, data.length, true);
    cv.setUint32(24, data.length, true);
    cv.setUint16(28, nameBytes.length, true);
    cv.setUint16(30, 0, true);
    cv.setUint16(32, 0, true);
    cv.setUint16(34, 0, true);
    cv.setUint16(36, 0, true);
    cv.setUint32(38, 32, true);
    cv.setUint32(42, offset, true);
    central.set(nameBytes, 46);
    centralHeaders.push(central);

    offset += local.length;
  }

  const centralSize = centralHeaders.reduce((a, b) => a + b.length, 0);

  // End of central directory
  const end = new Uint8Array(22);
  const ev = new DataView(end.buffer);
  ev.setUint32(0, 0x06054b50, true);
  ev.setUint16(4, 0, true);
  ev.setUint16(6, 0, true);
  ev.setUint16(8, files.length, true);
  ev.setUint16(10, files.length, true);
  ev.setUint32(12, centralSize, true);
  ev.setUint32(16, offset, true);
  ev.setUint16(20, 0, true);

  return new Blob([...localHeaders, ...centralHeaders, end], { type: 'application/zip' });
}

function crc32(data) {
  let crc = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++) {
    crc ^= data[i];
    for (let j = 0; j < 8; j++) {
      crc = (crc >>> 1) ^ (crc & 1 ? 0xEDB88320 : 0);
    }
  }
  return (crc ^ 0xFFFFFFFF) >>> 0;
}

// ‚îÄ‚îÄ‚îÄ Keyboard shortcut for back (desktop testing) ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetail();
});

// ‚îÄ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

// ‚îÄ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
