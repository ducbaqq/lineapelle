<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a1a1a">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<title>LineaPelle 2026</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1a1a1a;--bg2:#242424;--bg3:#2e2e2e;
  --fg:#f0f0f0;--fg2:#aaa;--fg3:#777;
  --cyan:#00BCD4;--purple:#9C27B0;--yellow:#FFC107;
  --green:#4CAF50;--red:#e53935;
  --accent:#8B5A2B;--danger:#e53935;
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{
  height:100%;background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;overflow:hidden;
  touch-action:pan-y;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header{
  position:fixed;top:0;left:0;right:0;z-index:100;
  background:var(--bg);
  padding-top:calc(var(--safe-top) + 8px);
  border-bottom:1px solid var(--bg3);
}
.header-top{display:flex;align-items:center;justify-content:space-between;padding:0 12px 8px}
.header-title{font-size:20px;font-weight:700;letter-spacing:0.5px;color:var(--fg);flex:1;text-align:center}
.header-left,.header-right{display:flex;gap:4px;min-width:40px}
.header-right{justify-content:flex-end}
.hdr-btn{
  background:none;border:none;color:var(--fg2);font-size:18px;
  padding:6px 8px;cursor:pointer;border-radius:8px;
}
.hdr-btn:active{background:var(--bg3)}
.tabs{display:flex}
.tab{
  flex:1;text-align:center;padding:10px 0;font-size:14px;font-weight:600;
  color:var(--fg3);cursor:pointer;position:relative;transition:color .2s;
}
.tab.active{color:var(--fg)}
.tab.active::after{
  content:'';position:absolute;bottom:0;left:20%;right:20%;
  height:2px;background:var(--accent);border-radius:2px;
}
.tab-count{font-weight:400;color:var(--fg3);font-size:12px;margin-left:4px}

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
.search-wrap{
  overflow:hidden;max-height:0;transition:max-height .25s ease;
  border-bottom:1px solid transparent;
}
.search-wrap.open{max-height:56px;border-bottom-color:var(--bg3)}
.search-bar{padding:8px 12px;position:relative}
.search-input{
  width:100%;padding:10px 14px 10px 36px;border-radius:10px;
  border:none;background:var(--bg3);color:var(--fg);font-size:15px;outline:none;
}
.search-input::placeholder{color:var(--fg3)}
.search-icon{
  position:absolute;left:24px;top:50%;transform:translateY(-50%);
  color:var(--fg3);font-size:14px;pointer-events:none;
}

/* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:var(--bg);border-top:1px solid var(--bg3);
  display:flex;padding-bottom:var(--safe-bot);
}
.nav-item{
  flex:1;text-align:center;padding:10px 0 8px;cursor:pointer;
  transition:color .2s;color:var(--fg3);
}
.nav-item.active{color:var(--fg)}
.nav-icon{font-size:20px;line-height:1}
.nav-label{font-size:10px;font-weight:600;margin-top:2px;letter-spacing:0.3px}
.nav-badge{font-size:9px;font-weight:400;color:var(--fg3)}

/* ‚îÄ‚îÄ List ‚îÄ‚îÄ */
.list-container{
  position:fixed;top:0;left:0;right:0;bottom:0;
  padding-top:calc(var(--safe-top) + 90px);
  padding-bottom:calc(var(--safe-bot) + 62px);
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.list{padding:8px 12px}
.empty-state{text-align:center;color:var(--fg3);padding:60px 20px;font-size:15px}

/* ‚îÄ‚îÄ Section Headers (Visited tab) ‚îÄ‚îÄ */
.list-section-header{
  font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:1px;
  color:var(--fg3);padding:16px 0 6px;display:flex;align-items:center;gap:8px;
}
.list-section-header:first-child{padding-top:4px}
.list-section-header .sh-icon{font-size:16px}

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card-wrap{position:relative;margin-bottom:8px}
.card-actions{
  position:absolute;top:0;right:0;bottom:0;
  display:flex;align-items:stretch;border-radius:12px;overflow:hidden;
}
.card-action{
  width:64px;display:flex;align-items:center;justify-content:center;
  font-size:24px;cursor:pointer;border:none;color:#fff;
}
.card-action.act-up{background:var(--green)}
.card-action.act-down{background:var(--red)}
.card-action.act-back{background:var(--fg3)}
.card{
  background:var(--bg2);border-radius:12px;padding:14px 16px;
  position:relative;overflow:hidden;
  transition:transform .3s ease,opacity .3s ease;
  cursor:pointer;user-select:none;-webkit-user-select:none;
}
.card::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:5px;
  border-radius:12px 0 0 12px;
  background:var(--card-border,transparent);
}
.card.swiping{transition:none}
.card.removing{pointer-events:none}
.card-body{min-width:0}
.card-name{font-size:15px;font-weight:600;line-height:1.3}
.card-booth{font-size:13px;color:var(--fg2);margin-top:2px}
.card-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.tag-pill{
  font-size:10px;font-weight:600;padding:2px 7px;border-radius:10px;
  text-transform:uppercase;letter-spacing:0.3px;
}
.tag-pill.transparent{background:rgba(0,188,212,.15);color:var(--cyan)}
.tag-pill.exotic{background:rgba(156,39,176,.15);color:var(--purple)}
.tag-pill.novel{background:rgba(255,193,7,.15);color:var(--yellow)}

/* ‚îÄ‚îÄ Confirmation Modal ‚îÄ‚îÄ */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;
  background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-overlay.open{opacity:1;pointer-events:auto}
.modal{
  background:var(--bg2);border-radius:16px;padding:24px;
  width:280px;text-align:center;
}
.modal-icon{font-size:40px;margin-bottom:8px}
.modal-text{font-size:15px;margin-bottom:20px;color:var(--fg2)}
.modal-name{font-weight:700;color:var(--fg)}
.modal-btns{display:flex;gap:10px}
.modal-btn{
  flex:1;padding:12px;border-radius:10px;border:none;
  font-size:15px;font-weight:600;cursor:pointer;
}
.modal-btn.cancel{background:var(--bg3);color:var(--fg)}
.modal-btn.confirm-up{background:var(--green);color:#fff}
.modal-btn.confirm-down{background:var(--red);color:#fff}
.modal-btn.confirm-back{background:var(--fg3);color:#fff}
.modal-btn:active{filter:brightness(.85)}

/* ‚îÄ‚îÄ Detail View ‚îÄ‚îÄ */
.detail-view{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;
  background:var(--bg);
  transform:translateX(100%);transition:transform .3s ease;
  overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding-top:calc(var(--safe-top));
  padding-bottom:calc(var(--safe-bot) + 20px);
}
.detail-view.open{transform:translateX(0)}
.detail-header{
  position:sticky;top:0;z-index:10;background:var(--bg);
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;border-bottom:1px solid var(--bg3);gap:8px;
}
.detail-back{
  background:none;border:none;color:var(--fg);font-size:15px;
  cursor:pointer;padding:6px 10px;border-radius:8px;
  display:flex;align-items:center;gap:4px;flex-shrink:0;
}
.detail-back:active{background:var(--bg3)}
.detail-back:disabled{opacity:.3;pointer-events:none}
.detail-back .arrow{font-size:18px}
.detail-actions{display:flex;align-items:center;gap:6px}
.rate-btn{
  width:40px;height:40px;border-radius:50%;border:2px solid var(--bg3);
  background:none;font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:border-color .2s,background .2s;
}
.rate-btn:active{filter:brightness(.85)}
.rate-btn.active-up{border-color:var(--green);background:rgba(76,175,80,.2)}
.rate-btn.active-down{border-color:var(--red);background:rgba(229,57,53,.2)}
.rec-btn{
  background:var(--danger);color:#fff;border:none;
  font-size:14px;font-weight:600;padding:8px 14px;border-radius:20px;
  cursor:pointer;display:flex;align-items:center;gap:6px;
  transition:background .2s;flex-shrink:0;
}
.rec-btn:active{filter:brightness(.85)}
.rec-btn.recording{animation:pulse 1.2s infinite}
.rec-timer{font-variant-numeric:tabular-nums;font-size:13px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

.detail-content{padding:16px}
.detail-name{font-size:22px;font-weight:700;margin-bottom:4px}
.detail-booth{font-size:14px;color:var(--fg2);margin-bottom:12px}
.detail-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:16px}

.detail-row{display:flex;gap:12px}
.detail-row .section{flex:1;min-width:0}

.section{margin-bottom:20px}
.section-title{
  font-size:12px;font-weight:700;text-transform:uppercase;
  letter-spacing:1px;color:var(--fg3);margin-bottom:8px;
  padding-bottom:4px;border-bottom:1px solid var(--bg3);
}
.memos-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid rgba(220,220,220,.3);
}
.memos-header .section-title{
  color:#ddd;border-bottom:none;margin-bottom:0;padding-bottom:0;
}
.dl-all-btn{
  font-size:11px;color:var(--cyan);background:none;border:none;
  cursor:pointer;font-weight:600;padding:2px 6px;border-radius:6px;
}
.dl-all-btn:active{background:var(--bg3)}
.field{margin-bottom:8px}
.field-label{font-size:12px;color:var(--fg3);margin-bottom:1px}
.field-value{font-size:14px;line-height:1.4}
.field-value a{color:var(--cyan);text-decoration:none}
.field-value a:active{text-decoration:underline}

/* ‚îÄ‚îÄ Recordings ‚îÄ‚îÄ */
.recording-item{
  background:var(--bg3);border-radius:10px;padding:12px;
  margin-bottom:6px;display:flex;align-items:center;gap:10px;
}
.recording-info{flex:1;min-width:0}
.recording-time{font-size:12px;color:var(--fg2)}
.recording-dur{font-size:11px;color:var(--fg3)}
.recording-actions{display:flex;gap:6px}
.recording-actions button{
  background:var(--bg2);border:none;color:var(--fg);
  width:36px;height:36px;border-radius:50%;font-size:16px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.recording-actions button:active{background:var(--bg)}
.audio-playing{background:var(--accent) !important}
</style>
</head>
<body>

<!-- List View -->
<div class="header" id="listHeader">
  <div class="header-top">
    <div class="header-left"></div>
    <div class="header-title">LineaPelle 2026</div>
    <div class="header-right">
      <button class="hdr-btn" onclick="toggleSearch()" title="Search">üîç</button>
      <button class="hdr-btn" onclick="exportAllRecordings()" title="Export">üì¶</button>
    </div>
  </div>
  <div class="search-wrap" id="searchWrap">
    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input class="search-input" id="searchInput" type="text" placeholder="Search..." oninput="renderList()">
    </div>
  </div>
  <div class="tabs">
    <div class="tab active" id="tabTovisit" onclick="switchTab('tovisit')">
      To Visit <span class="tab-count" id="countTovisit"></span>
    </div>
    <div class="tab" id="tabVisited" onclick="switchTab('visited')">
      Visited <span class="tab-count" id="countVisited"></span>
    </div>
  </div>
</div>

<div class="list-container" id="listContainer">
  <div class="list" id="list"></div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <div class="nav-item active" id="navTier1" onclick="switchSection('tier1')">
    <div class="nav-icon">ü•á</div>
    <div class="nav-label">Tier 1</div>
    <div class="nav-badge" id="navCount1"></div>
  </div>
  <div class="nav-item" id="navTier2" onclick="switchSection('tier2')">
    <div class="nav-icon">ü•à</div>
    <div class="nav-label">Tier 2</div>
    <div class="nav-badge" id="navCount2"></div>
  </div>
  <div class="nav-item" id="navTier3" onclick="switchSection('tier3')">
    <div class="nav-icon">ü•â</div>
    <div class="nav-label">Tier 3</div>
    <div class="nav-badge" id="navCount3"></div>
  </div>
  <div class="nav-item" id="navTier4" onclick="switchSection('tier4')">
    <div class="nav-icon">‚è≠Ô∏è</div>
    <div class="nav-label">Tier 4</div>
    <div class="nav-badge" id="navCount4"></div>
  </div>
  <div class="nav-item" id="navAccessories" onclick="switchSection('accessories')">
    <div class="nav-icon">‚öôÔ∏è</div>
    <div class="nav-label">Acc.</div>
    <div class="nav-badge" id="navCountAcc"></div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="modalCancel()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-icon" id="modalIcon"></div>
    <div class="modal-text" id="modalText"></div>
    <div class="modal-btns">
      <button class="modal-btn cancel" onclick="modalCancel()">Cancel</button>
      <button class="modal-btn" id="modalConfirmBtn" onclick="modalConfirm()">Confirm</button>
    </div>
  </div>
</div>

<!-- Detail View -->
<div class="detail-view" id="detailView">
  <div class="detail-header">
    <button class="detail-back" id="backBtn" onclick="closeDetail()">
      <span class="arrow">‚Äπ</span> Back
    </button>
    <div class="detail-actions">
      <button class="rate-btn" id="detailUp" onclick="rateFromDetail('up')" title="Thumbs up">üëç</button>
      <button class="rate-btn" id="detailDown" onclick="rateFromDetail('down')" title="Thumbs down">üëé</button>
      <button class="rec-btn" id="recBtn" onclick="toggleRecording()">
        <span id="recIcon">üéô</span>
        <span id="recLabel">Rec</span>
        <span class="rec-timer" id="recTimer" style="display:none">00:00</span>
      </button>
    </div>
  </div>
  <div class="detail-content" id="detailContent"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
const allData = { tier1: [], tier2: [], tier3: [], tier4: [], accessories: [] };
let ratings = { tier1: {}, tier2: {}, tier3: {}, tier4: {}, accessories: {} };
let activeSection = 'tier1';
let activeTab = 'tovisit';
let currentTannery = null;
let db = null;

// Recording
let mediaRecorder = null;
let recordingChunks = [];
let recordingStart = 0;
let recordingTimer = null;
let isRecording = false;
let currentAudio = null;
let currentPlayBtn = null;

// Modal
let pendingAction = null; // { itemId, action:'up'|'down'|'back', card }

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
async function init() {
  const [r1, r2, r3, r4, r5] = await Promise.all([
    fetch('tanneries.json').then(r => r.json()),
    fetch('tier2.json').then(r => r.json()),
    fetch('tier3.json').then(r => r.json()),
    fetch('tier4.json').then(r => r.json()),
    fetch('accessories.json').then(r => r.json())
  ]);
  const boothSort = (a, b) => (a['Booth'] || '').localeCompare(b['Booth'] || '', undefined, { numeric: true });
  allData.tier1 = r1.sort(boothSort);
  allData.tier2 = r2.sort(boothSort);
  allData.tier3 = r3.sort(boothSort);
  allData.tier4 = r4.sort(boothSort);
  allData.accessories = r5.sort(boothSort);

  try {
    const saved = localStorage.getItem('lp_ratings_v3');
    if (saved) ratings = JSON.parse(saved);
    if (!ratings.tier1) ratings.tier1 = {};
    if (!ratings.tier2) ratings.tier2 = {};
    if (!ratings.tier3) ratings.tier3 = {};
    if (!ratings.tier4) ratings.tier4 = {};
    if (!ratings.accessories) ratings.accessories = {};
  } catch(e) {}

  db = await openDB();
  updateNavCounts();
  renderList();
}

function saveRatings() {
  localStorage.setItem('lp_ratings_v3', JSON.stringify(ratings));
}
function currentItems() { return allData[activeSection]; }
function currentRatings() { return ratings[activeSection]; }

// ‚îÄ‚îÄ‚îÄ IndexedDB ‚îÄ‚îÄ‚îÄ
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('LineaPelleRecordings', 2);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('recordings')) {
        const store = db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
        store.createIndex('tanneryId', 'tanneryId', { unique: false });
      }
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}
function dbAdd(record) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readwrite');
    const req = tx.objectStore('recordings').add(record);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
function dbGetByTannery(tanneryId) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readonly');
    const idx = tx.objectStore('recordings').index('tanneryId');
    const req = idx.getAll(tanneryId);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
function dbGetAll() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readonly');
    const req = tx.objectStore('recordings').getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
function dbDelete(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction('recordings', 'readwrite');
    const req = tx.objectStore('recordings').delete(id);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}
function recKey(item) { return activeSection + '_' + item.id; }

// ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ
function toggleSearch() {
  const wrap = document.getElementById('searchWrap');
  wrap.classList.toggle('open');
  if (wrap.classList.contains('open')) {
    document.getElementById('searchInput').focus();
  } else {
    document.getElementById('searchInput').value = '';
    renderList();
  }
}

// ‚îÄ‚îÄ‚îÄ Sections ‚îÄ‚îÄ‚îÄ
function switchSection(section) {
  activeSection = section;
  activeTab = 'tovisit';
  document.getElementById('tabTovisit').classList.add('active');
  document.getElementById('tabVisited').classList.remove('active');
  document.getElementById('searchInput').value = '';
  document.getElementById('searchWrap').classList.remove('open');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navMap = { tier1:'navTier1', tier2:'navTier2', tier3:'navTier3', tier4:'navTier4', accessories:'navAccessories' };
  document.getElementById(navMap[section]).classList.add('active');
  document.getElementById('listContainer').scrollTop = 0;
  renderList();
}
function updateNavCounts() {
  document.getElementById('navCount1').textContent = allData.tier1.length;
  document.getElementById('navCount2').textContent = allData.tier2.length;
  document.getElementById('navCount3').textContent = allData.tier3.length;
  document.getElementById('navCount4').textContent = allData.tier4.length;
  document.getElementById('navCountAcc').textContent = allData.accessories.length;
}

// ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  activeTab = tab;
  document.getElementById('tabTovisit').classList.toggle('active', tab === 'tovisit');
  document.getElementById('tabVisited').classList.toggle('active', tab === 'visited');
  document.getElementById('searchInput').value = '';
  document.getElementById('searchWrap').classList.remove('open');
  renderList();
}

// ‚îÄ‚îÄ‚îÄ Tags ‚îÄ‚îÄ‚îÄ
function getSpecialTags(tags) {
  if (!tags) return [];
  const result = [];
  if (tags.includes('TRANSPARENT_LEATHER')) result.push({ key: 'transparent', label: 'Transparent', color: '#00BCD4' });
  if (tags.includes('EXOTIC_HIDE')) result.push({ key: 'exotic', label: 'Exotic', color: '#9C27B0' });
  if (tags.includes('NOVEL_MATERIAL')) result.push({ key: 'novel', label: 'Novel', color: '#FFC107' });
  return result;
}

function cardBorderStyle(tags) {
  const special = getSpecialTags(tags);
  if (special.length === 0) return '';
  if (special.length === 1) return `--card-border:${special[0].color}`;
  const colors = special.map(s => s.color);
  const stops = colors.map((c, i) => {
    const start = (i / colors.length * 100).toFixed(0);
    const end = ((i + 1) / colors.length * 100).toFixed(0);
    return `${c} ${start}%, ${c} ${end}%`;
  }).join(', ');
  return `--card-border:linear-gradient(to bottom, ${stops})`;
}

// ‚îÄ‚îÄ‚îÄ Render List ‚îÄ‚îÄ‚îÄ
function renderList() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  const listEl = document.getElementById('list');
  const items = currentItems();
  const rats = currentRatings();
  const isVisited = activeTab === 'visited';

  // Filter
  let filtered = items.filter(t => {
    const hasRating = rats[t.id] !== undefined;
    if (isVisited !== hasRating) return false;
    if (search) {
      const name = (t['Company Name'] || '').toLowerCase();
      const booth = (t['Booth'] || '').toLowerCase();
      const tags = (t['Tags'] || '').toLowerCase();
      return name.includes(search) || booth.includes(search) || tags.includes(search);
    }
    return true;
  });

  // Counts
  const ratedCount = items.filter(t => rats[t.id] !== undefined).length;
  document.getElementById('countTovisit').textContent = `(${items.length - ratedCount})`;
  document.getElementById('countVisited').textContent = `(${ratedCount})`;

  if (filtered.length === 0) {
    const label = activeSection === 'accessories' ? 'exhibitors' : 'tanneries';
    listEl.innerHTML = `<div class="empty-state">${isVisited
      ? `No ${label} rated yet.<br>Swipe left on a card to rate.`
      : search ? 'No matches found.' : `All ${label} rated! üéâ`
    }</div>`;
    return;
  }

  listEl.innerHTML = '';

  if (isVisited) {
    // Split into thumbs up and thumbs down, each sorted by booth
    const boothSort = (a, b) => (a['Booth'] || '').localeCompare(b['Booth'] || '', undefined, { numeric: true });
    const upItems = filtered.filter(t => rats[t.id] && rats[t.id].rating === 'up').sort(boothSort);
    const downItems = filtered.filter(t => rats[t.id] && rats[t.id].rating === 'down').sort(boothSort);

    if (upItems.length) {
      const hdr = document.createElement('div');
      hdr.className = 'list-section-header';
      hdr.innerHTML = `<span class="sh-icon">üëç</span> Interested (${upItems.length})`;
      listEl.appendChild(hdr);
      upItems.forEach(t => listEl.appendChild(createCard(t)));
    }
    if (downItems.length) {
      const hdr = document.createElement('div');
      hdr.className = 'list-section-header';
      hdr.innerHTML = `<span class="sh-icon">üëé</span> Not Interested (${downItems.length})`;
      listEl.appendChild(hdr);
      downItems.forEach(t => listEl.appendChild(createCard(t)));
    }
  } else {
    filtered.forEach(t => listEl.appendChild(createCard(t)));
  }
}

function createCard(t) {
  const rats = currentRatings();
  const rating = rats[t.id];
  const isRated = rating !== undefined;

  const wrap = document.createElement('div');
  wrap.className = 'card-wrap';

  // Action buttons behind the card
  const actions = document.createElement('div');
  actions.className = 'card-actions';

  if (!isRated) {
    // To Visit: show thumbs up + thumbs down
    actions.innerHTML = `
      <button class="card-action act-up" data-action="up">üëç</button>
      <button class="card-action act-down" data-action="down">üëé</button>
    `;
  } else {
    // Visited: show toggle rating + back
    if (rating.rating === 'up') {
      actions.innerHTML = `
        <button class="card-action act-down" data-action="down">üëé</button>
        <button class="card-action act-back" data-action="back">‚Ü©</button>
      `;
    } else {
      actions.innerHTML = `
        <button class="card-action act-up" data-action="up">üëç</button>
        <button class="card-action act-back" data-action="back">‚Ü©</button>
      `;
    }
  }
  wrap.appendChild(actions);

  // Card
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = t.id;
  card.setAttribute('style', cardBorderStyle(t['Tags']));

  const specialTags = getSpecialTags(t['Tags']);
  const pills = specialTags.map(s => `<span class="tag-pill ${s.key}">${s.label}</span>`).join('');

  card.innerHTML = `
    <div class="card-body">
      <div class="card-name">${esc(t['Company Name'])}</div>
      <div class="card-booth">${esc(t['Booth'])}</div>
      ${pills ? `<div class="card-tags">${pills}</div>` : ''}
    </div>
  `;

  wrap.appendChild(card);

  // Setup swipe + tap
  setupSwipe(wrap, card, t);
  card.addEventListener('click', e => {
    if (card.classList.contains('swiping') || card.classList.contains('swiped')) return;
    openDetail(t);
  });

  // Action button handlers
  actions.querySelectorAll('.card-action').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const action = btn.dataset.action;
      showModal(t, action, card);
    });
  });

  return wrap;
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// ‚îÄ‚îÄ‚îÄ Swipe (left to reveal actions) ‚îÄ‚îÄ‚îÄ
function setupSwipe(wrap, card, item) {
  let startX = 0, startY = 0, dx = 0, swiping = false, locked = false, swiped = false;
  const revealWidth = 128; // width of 2 action buttons

  card.addEventListener('touchstart', e => {
    if (swiped) {
      // If already swiped open, snap back on new touch
      card.style.transition = 'transform .2s ease';
      card.style.transform = '';
      card.classList.remove('swiped');
      setTimeout(() => { card.style.transition = ''; }, 200);
      swiped = false;
      return;
    }
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    dx = 0; swiping = false; locked = false;
    card.classList.remove('swiping');
  }, { passive: true });

  card.addEventListener('touchmove', e => {
    if (locked || swiped) return;
    const cx = e.touches[0].clientX;
    const cy = e.touches[0].clientY;
    const deltaX = cx - startX;
    const deltaY = cy - startY;

    if (!swiping && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) return;
    if (!swiping) {
      if (Math.abs(deltaY) > Math.abs(deltaX)) { locked = true; return; }
      swiping = true;
      card.classList.add('swiping');
    }

    // Only allow left swipe
    if (deltaX > 0) { dx = 0; card.style.transform = ''; return; }
    dx = Math.max(deltaX, -revealWidth);
    card.style.transform = `translateX(${dx}px)`;
  }, { passive: true });

  card.addEventListener('touchend', e => {
    if (!swiping) return;
    card.classList.remove('swiping');

    if (dx < -50) {
      // Snap to reveal
      card.style.transition = 'transform .2s ease';
      card.style.transform = `translateX(-${revealWidth}px)`;
      card.classList.add('swiped');
      swiped = true;
      setTimeout(() => { card.style.transition = ''; }, 200);
    } else {
      // Snap back
      card.style.transition = 'transform .2s ease';
      card.style.transform = '';
      setTimeout(() => { card.style.transition = ''; }, 200);
    }
  }, { passive: true });
}

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ
function showModal(item, action, card) {
  pendingAction = { itemId: item.id, action, card, name: item['Company Name'] };
  const overlay = document.getElementById('modalOverlay');
  const icon = document.getElementById('modalIcon');
  const text = document.getElementById('modalText');
  const btn = document.getElementById('modalConfirmBtn');

  const name = `<span class="modal-name">${esc(item['Company Name'])}</span>`;
  if (action === 'up') {
    icon.textContent = 'üëç';
    text.innerHTML = `Rate ${name} as interested?`;
    btn.className = 'modal-btn confirm-up';
  } else if (action === 'down') {
    icon.textContent = 'üëé';
    text.innerHTML = `Rate ${name} as not interested?`;
    btn.className = 'modal-btn confirm-down';
  } else {
    icon.textContent = '‚Ü©';
    text.innerHTML = `Move ${name} back to To Visit?`;
    btn.className = 'modal-btn confirm-back';
  }
  btn.textContent = 'Confirm';
  overlay.classList.add('open');
}

function modalConfirm() {
  if (!pendingAction) return;
  const { itemId, action, card } = pendingAction;
  const rats = currentRatings();

  document.getElementById('modalOverlay').classList.remove('open');

  // Animate card out
  if (card) {
    card.classList.add('removing');
    card.style.transition = 'transform .3s ease, opacity .3s ease';
    card.style.transform = `translateX(-${window.innerWidth}px)`;
    card.style.opacity = '0';
  }

  setTimeout(() => {
    if (action === 'back') {
      delete rats[itemId];
    } else {
      rats[itemId] = { rating: action, ts: Date.now() };
    }
    saveRatings();
    renderList();
    // Update detail view rating buttons if open
    if (currentTannery && currentTannery.id === itemId) updateDetailRatingUI();
  }, card ? 300 : 0);

  pendingAction = null;
}

function modalCancel() {
  document.getElementById('modalOverlay').classList.remove('open');
  // Snap card back
  if (pendingAction && pendingAction.card) {
    const card = pendingAction.card;
    card.style.transition = 'transform .2s ease';
    card.style.transform = '';
    card.classList.remove('swiped');
    setTimeout(() => { card.style.transition = ''; }, 200);
  }
  pendingAction = null;
}

// ‚îÄ‚îÄ‚îÄ Detail View ‚îÄ‚îÄ‚îÄ
async function openDetail(item) {
  currentTannery = item;
  const view = document.getElementById('detailView');
  const content = document.getElementById('detailContent');

  const specialTags = getSpecialTags(item['Tags']);
  const pills = specialTags.map(s => `<span class="tag-pill ${s.key}">${s.label}</span>`).join('');

  let html = `
    <div class="detail-name">${esc(item['Company Name'])}</div>
    <div class="detail-booth">${esc(item['Booth'])}</div>
    ${pills ? `<div class="detail-tags">${pills}</div>` : ''}
  `;

  // Basic Info + Classification side by side
  const basicFields = [];
  addField(basicFields, 'Country', item['Country']);
  if (item['Website']) {
    const url = item['Website'].startsWith('http') ? item['Website'] : 'https://' + item['Website'];
    basicFields.push({ label: 'Website', value: `<a href="${esc(url)}" target="_blank" rel="noopener">${esc(item['Website'])}</a>` });
  }
  if (item['Email']) basicFields.push({ label: 'Email', value: `<a href="mailto:${esc(item['Email'])}">${esc(item['Email'])}</a>` });
  if (item['Phone']) basicFields.push({ label: 'Phone', value: `<a href="tel:${esc(item['Phone'])}">${esc(item['Phone'])}</a>` });

  const classFields = [];
  addField(classFields, 'Sector', item['Sector']);
  addField(classFields, 'Typology', item['Typology']);
  addField(classFields, 'Priority Score', item['Priority Score']);
  if (item['Tags']) {
    classFields.push({ label: 'Tags', value: item['Tags'].split(',').map(t => {
      const tag = t.trim();
      const special = getSpecialTags(tag);
      const cls = special.length ? special[0].key : '';
      return `<span class="tag-pill ${cls}" style="${cls ? '' : 'background:var(--bg3);color:var(--fg2)'}">${tag.replace(/_/g, ' ')}</span>`;
    }).join(' ') });
  }

  if (basicFields.length || classFields.length) {
    html += '<div class="detail-row">';
    if (basicFields.length) html += renderSection('Basic Info', basicFields);
    if (classFields.length) html += renderSection('Classification', classFields);
    html += '</div>';
  }

  // Summary ‚Äî right after classification
  const sumFields = [];
  addField(sumFields, 'Distinctive Summary', item['Distinctive Summary']);
  addField(sumFields, 'Notes', item['Notes']);
  if (sumFields.length) html += renderSection('Summary', sumFields);

  if (activeSection === 'tier4') {
    // Tier 4 has minimal data ‚Äî just reason for skipping
    const t4Fields = [];
    addField(t4Fields, 'Reason', item['Reason']);
    if (t4Fields.length) html += renderSection('Skip Reason', t4Fields);
  } else if (activeSection === 'accessories') {
    const prodFields = [];
    addField(prodFields, 'Product Types', item['Product Types']);
    addField(prodFields, 'Hardware Types', item['Hardware Types']);
    addField(prodFields, 'Materials', item['Materials']);
    addField(prodFields, 'Product Description', item['Product Description']);
    const bizFields = [];
    addField(bizFields, 'MOQ Info', item['MOQ Info']);
    addField(bizFields, 'Custom Work', item['Custom Work']);
    if (prodFields.length || bizFields.length) {
      html += '<div class="detail-row">';
      if (prodFields.length) html += renderSection('Products', prodFields);
      if (bizFields.length) html += renderSection('Business', bizFields);
      html += '</div>';
    }
  } else {
    // Tannery fields (Tier 1, 2, 3)
    const prodFields = [];
    addField(prodFields, 'Hide Types', item['Hide Types']);
    addField(prodFields, 'Tanning Methods', item['Tanning Methods']);
    addField(prodFields, 'Thickness Range', item['Thickness Range']);
    addField(prodFields, 'Finishes (Catalog)', item['Finishes (Catalog)']);
    addField(prodFields, 'Interesting Finishes', item['Interesting Finishes']);
    addField(prodFields, 'Exotic Hides', item['Exotic Hides']);
    addField(prodFields, 'Novel Materials', item['Novel Materials']);
    addField(prodFields, 'Transparent Leather', item['Transparent Leather']);
    addField(prodFields, 'Combined Materials', item['Combined Materials']);
    const bizFields = [];
    addField(bizFields, 'MOQ Info', item['MOQ Info']);
    addField(bizFields, 'Custom Work', item['Custom Work']);
    addField(bizFields, 'Ethical / Sustainability', item['Ethical/Sustainability']);
    addField(bizFields, 'Destinations', item['Destinations']);
    if (prodFields.length || bizFields.length) {
      html += '<div class="detail-row">';
      if (prodFields.length) html += renderSection('Products & Materials', prodFields);
      if (bizFields.length) html += renderSection('Business', bizFields);
      html += '</div>';
    }
  }

  html += `<div class="section"><div class="memos-header"><div class="section-title">Voice Memos</div><button class="dl-all-btn" id="dlAllMemosBtn" onclick="downloadAllMemos()" style="display:none">Download All</button></div><div id="memosList"></div></div>`;
  content.innerHTML = html;
  view.classList.add('open');
  view.scrollTop = 0;
  updateDetailRatingUI();
  await loadRecordings();
}

function updateDetailRatingUI() {
  if (!currentTannery) return;
  const rats = currentRatings();
  const r = rats[currentTannery.id];
  const upBtn = document.getElementById('detailUp');
  const downBtn = document.getElementById('detailDown');
  upBtn.classList.remove('active-up');
  downBtn.classList.remove('active-down');
  if (r && r.rating === 'up') upBtn.classList.add('active-up');
  if (r && r.rating === 'down') downBtn.classList.add('active-down');
}

function rateFromDetail(action) {
  if (!currentTannery) return;
  const rats = currentRatings();
  const current = rats[currentTannery.id];

  // If already this rating, do nothing
  if (current && current.rating === action) return;

  showModal(currentTannery, action, null);
}

function addField(arr, label, value) {
  if (value && value.trim()) arr.push({ label, value: esc(value) });
}

function renderSection(title, fields) {
  return `<div class="section">
    <div class="section-title">${title}</div>
    ${fields.map(f => `<div class="field"><div class="field-label">${f.label}</div><div class="field-value">${f.value}</div></div>`).join('')}
  </div>`;
}

function closeDetail() {
  if (isRecording) return;
  document.getElementById('detailView').classList.remove('open');
  stopAudio();
  currentTannery = null;
  renderList(); // refresh list to reflect any rating changes
}

// ‚îÄ‚îÄ‚îÄ Recordings ‚îÄ‚îÄ‚îÄ
async function loadRecordings() {
  if (!currentTannery || !db) return;
  const key = recKey(currentTannery);
  const recs = await dbGetByTannery(key);
  recs.sort((a, b) => a.timestamp - b.timestamp);
  const el = document.getElementById('memosList');
  const dlBtn = document.getElementById('dlAllMemosBtn');
  if (!recs.length) {
    el.innerHTML = '<div style="color:var(--fg3);font-size:13px">No recordings yet. Tap Rec to start.</div>';
    if (dlBtn) dlBtn.style.display = 'none';
    return;
  }
  if (dlBtn) dlBtn.style.display = '';
  el.innerHTML = recs.map(r => `
    <div class="recording-item" id="rec-${r.id}">
      <div class="recording-info">
        <div class="recording-time">${new Date(r.timestamp).toLocaleString()}</div>
        <div class="recording-dur">${formatDuration(r.duration)}</div>
      </div>
      <div class="recording-actions">
        <button onclick="playRecording(${r.id}, this)" title="Play">‚ñ∂</button>
        <button onclick="downloadRecording(${r.id})" title="Download">üíæ</button>
        <button onclick="deleteRecording(${r.id})" title="Delete" style="color:var(--danger)">‚úï</button>
      </div>
    </div>
  `).join('');
}

function formatDuration(ms) {
  if (!ms) return '0:00';
  const s = Math.round(ms / 1000);
  const m = Math.floor(s / 60);
  return `${m}:${String(s % 60).padStart(2, '0')}`;
}

async function playRecording(id, btn) {
  stopAudio();
  const tx = db.transaction('recordings', 'readonly');
  const req = tx.objectStore('recordings').get(id);
  req.onsuccess = () => {
    const rec = req.result;
    if (!rec) return;
    const url = URL.createObjectURL(rec.blob);
    currentAudio = new Audio(url);
    currentPlayBtn = btn;
    btn.textContent = '‚è∏';
    btn.parentElement.parentElement.classList.add('audio-playing');
    currentAudio.onended = () => stopAudio();
    currentAudio.play();
  };
}

function stopAudio() {
  if (currentAudio) { currentAudio.pause(); currentAudio = null; }
  if (currentPlayBtn) {
    currentPlayBtn.textContent = '‚ñ∂';
    currentPlayBtn.parentElement.parentElement.classList.remove('audio-playing');
    currentPlayBtn = null;
  }
}

async function downloadRecording(id) {
  const tx = db.transaction('recordings', 'readonly');
  const req = tx.objectStore('recordings').get(id);
  req.onsuccess = () => {
    const rec = req.result;
    if (!rec) return;
    const url = URL.createObjectURL(rec.blob);
    const a = document.createElement('a');
    a.href = url; a.download = rec.filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  };
}

async function deleteRecording(id) {
  if (!confirm('Delete this recording?')) return;
  stopAudio();
  await dbDelete(id);
  await loadRecordings();
}

async function downloadAllMemos() {
  if (!currentTannery || !db) return;
  const recs = await dbGetByTannery(recKey(currentTannery));
  if (!recs.length) return;
  const slug = slugify(currentTannery['Company Name']);
  const files = [];
  for (const r of recs) {
    const buf = await r.blob.arrayBuffer();
    files.push({ name: `${slug}/${r.filename}`, data: new Uint8Array(buf) });
  }
  const zipBlob = createZip(files);
  const url = URL.createObjectURL(zipBlob);
  const a = document.createElement('a');
  a.href = url; a.download = `${slug}_memos.zip`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// ‚îÄ‚îÄ‚îÄ Voice Recording ‚îÄ‚îÄ‚îÄ
async function toggleRecording() {
  if (isRecording) stopRecordingSession();
  else await startRecordingSession();
}

async function startRecordingSession() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recordingChunks = [];
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
    mediaRecorder = new MediaRecorder(stream, { mimeType });
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordingChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      const blob = new Blob(recordingChunks, { type: mediaRecorder.mimeType });
      const duration = Date.now() - recordingStart;
      const ext = mediaRecorder.mimeType.includes('mp4') ? 'mp4' : 'webm';
      const slug = slugify(currentTannery['Company Name']);
      const ts = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
      await dbAdd({ tanneryId: recKey(currentTannery), filename: `${slug}_${ts}.${ext}`, timestamp: Date.now(), duration, blob });
      await loadRecordings();
    };
    mediaRecorder.start(1000);
    recordingStart = Date.now();
    isRecording = true;
    updateRecordingUI();
    recordingTimer = setInterval(() => {
      document.getElementById('recTimer').textContent = formatDuration(Date.now() - recordingStart);
    }, 200);
  } catch (err) {
    alert('Microphone access denied. Please allow microphone access in your device settings.');
  }
}

function stopRecordingSession() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  isRecording = false;
  clearInterval(recordingTimer);
  updateRecordingUI();
}

function updateRecordingUI() {
  const btn = document.getElementById('recBtn');
  const icon = document.getElementById('recIcon');
  const label = document.getElementById('recLabel');
  const timer = document.getElementById('recTimer');
  const back = document.getElementById('backBtn');
  if (isRecording) {
    btn.classList.add('recording'); icon.textContent = '‚èπ'; label.textContent = 'Stop';
    timer.style.display = ''; back.disabled = true;
  } else {
    btn.classList.remove('recording'); icon.textContent = 'üéô'; label.textContent = 'Rec';
    timer.style.display = 'none'; timer.textContent = '00:00'; back.disabled = false;
  }
}

function slugify(name) {
  return (name || 'unknown').toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').slice(0, 50);
}

// ‚îÄ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ
async function exportAllRecordings() {
  const recs = await dbGetAll();
  if (!recs.length) { alert('No recordings to export.'); return; }
  const files = [];
  for (const r of recs) {
    const parts = r.tanneryId.split('_');
    const section = parts[0] === 'accessories' ? 'accessories' : parts[0];
    const id = parseInt(parts.slice(1).join('_'));
    const sectionData = allData[section] || [];
    const item = sectionData.find(t => t.id === id);
    const folder = item ? slugify(item['Company Name']) : 'unknown';
    const arrayBuf = await r.blob.arrayBuffer();
    files.push({ name: `${section}/${folder}/${r.filename}`, data: new Uint8Array(arrayBuf) });
  }
  const zipBlob = createZip(files);
  const url = URL.createObjectURL(zipBlob);
  const a = document.createElement('a');
  a.href = url; a.download = `lineapelle_recordings_${new Date().toISOString().slice(0,10)}.zip`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function createZip(files) {
  const localHeaders = [], centralHeaders = [];
  let offset = 0;
  for (const file of files) {
    const nameBytes = new TextEncoder().encode(file.name);
    const data = file.data, crc = crc32(data);
    const local = new Uint8Array(30 + nameBytes.length + data.length);
    const lv = new DataView(local.buffer);
    lv.setUint32(0, 0x04034b50, true); lv.setUint16(4, 20, true);
    lv.setUint16(6, 0, true); lv.setUint16(8, 0, true);
    lv.setUint16(10, 0, true); lv.setUint16(12, 0, true);
    lv.setUint32(14, crc, true); lv.setUint32(18, data.length, true);
    lv.setUint32(22, data.length, true); lv.setUint16(26, nameBytes.length, true);
    lv.setUint16(28, 0, true);
    local.set(nameBytes, 30); local.set(data, 30 + nameBytes.length);
    localHeaders.push(local);
    const central = new Uint8Array(46 + nameBytes.length);
    const cv = new DataView(central.buffer);
    cv.setUint32(0, 0x02014b50, true); cv.setUint16(4, 20, true);
    cv.setUint16(6, 20, true); cv.setUint16(8, 0, true);
    cv.setUint16(10, 0, true); cv.setUint16(12, 0, true);
    cv.setUint16(14, 0, true); cv.setUint32(16, crc, true);
    cv.setUint32(20, data.length, true); cv.setUint32(24, data.length, true);
    cv.setUint16(28, nameBytes.length, true); cv.setUint16(30, 0, true);
    cv.setUint16(32, 0, true); cv.setUint16(34, 0, true);
    cv.setUint16(36, 0, true); cv.setUint32(38, 32, true);
    cv.setUint32(42, offset, true);
    central.set(nameBytes, 46); centralHeaders.push(central);
    offset += local.length;
  }
  const centralSize = centralHeaders.reduce((a, b) => a + b.length, 0);
  const end = new Uint8Array(22);
  const ev = new DataView(end.buffer);
  ev.setUint32(0, 0x06054b50, true); ev.setUint16(4, 0, true);
  ev.setUint16(6, 0, true); ev.setUint16(8, files.length, true);
  ev.setUint16(10, files.length, true); ev.setUint32(12, centralSize, true);
  ev.setUint32(16, offset, true); ev.setUint16(20, 0, true);
  return new Blob([...localHeaders, ...centralHeaders, end], { type: 'application/zip' });
}

function crc32(data) {
  let crc = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++) {
    crc ^= data[i];
    for (let j = 0; j < 8; j++) crc = (crc >>> 1) ^ (crc & 1 ? 0xEDB88320 : 0);
  }
  return (crc ^ 0xFFFFFFFF) >>> 0;
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
init();
</script>
</body>
</html>
